on:
  workflow_call:
    inputs:
      actor:
        required: true
        type: string
      pr-name:
        required: true
        type: string
    secrets:
      NODE_AUTH_TOKEN:
        required: true
jobs:
  bump-sst-npm:
    name: Sync SST Versions
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: inputs.actor == 'renovate[bot]' && (contains(inputs.pr-name, 'serverless stack') || contains(inputs.pr-name, 'sst'))
    steps:
      - uses: actions/github-script@v6
        id: get-version
        with:
          result-encoding: string
          script: |
            const packageJSON = require('fs').readFileSync(`${{ github.workspace }}/package.json`).toString();
            const packageFile = JSON.parse(packageJSON);
            return packageFile.dependencies?.['@serverless-stack/resources'] ?? packageFile.devDependencies?.['@serverless-stack/resources'];
      - name: Update SST and CDK to Latest Versions
        run: npx -p @serverless-stack/cli sst update ${{ steps.get-version.outputs.result }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Commit updated dependencies
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: >
            chore(deps): update SST dependencies to latest version
          file_pattern: '**/package.json **/package-lock.json'
